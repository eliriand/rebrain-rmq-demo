# Выпускной проект по курсу "RabbitMQ" на платформе Rebrain.

## Описание

Проект представляет собой страховую компанию с офисами в Санкт-Петербурге и Москве.

Каждый филиал генерирует одно из трех действий:
- Регистрация нового полиса с указанием его стоимости и почтового адреса клиента
- Регистрация выплаты по страховому случае с указанием суммы и почтового адреса клиента
- Регистрация страхового случая с указанием почтового адреса клиента

Помимо самих филиалов и сервисов, обрабатывающих события по полису, присутствует сервис, выполняющий деперсонализацию событий для последующей передачи аналитикам. Разместить шину данных для него на общей шине страховой компании запрещено политиками ИБ.

## Структура репозитория

### docker-compose.yml
Конфиг для docker-compose, требуется для запуска окружения

### rmq_main
Директория с конфигурацией и dockerfile для основной шины данных компании. Принимает сообщения от филиалов, распределяет их по очередям для передачи сервисам.
При помощи shovel передает данные в инстанс RabbitMQ, служащий для деперсонализации данных

### rmq_depers
Директория с конфигурацией и dockerfile для шины данных сверсиса деперсонализации, принимает данные с основной шины через shovel

### police_registration_publisher
Cервис генерации событий регистрации новых полисов. Раз в случайный промежуток времени генерирует событие регистрации полиса в случайном офисе на случайный почтовый адрес, отправляет его в rmq_main, логирует в stdout.

### insurance_event_registration_publisher
Сервис генерации событий-выплат и событий-регистрации страховых случаев.
Раз в случайный промежуток времени генерирует событие случайного типа в случайном офисе на случайный почтовый адрес, отправляет в rmq_main. Логирует в stdout.

### depersonation_service
Сервис деперсонализции. Вычитывает события из очереди, для каждого заменяет почтовый адрес на плейсхолдер. Логирует в stdout.

### incident_processing_service
Запускается в двух экземплярах для каждого офиса. Вычитывает события из очереди, логирует в stdout.

### logger_service
Логирует все события для указанного офиса, запускается для каждого офиса. Вычитывает события из очереди, логирует в stdout.

### payments_logger_service
Логирует все события по выплатам по страховым случаем для обоих офисов разом. Логиурет в stdout.

### payments_processing_service
Логирует события выплат для указанного офиса, запускается для каждого. Вычитывает события из очереди, логирует в stdout.

### police_registration_service
Логирует события регистрации новых полисов с указанием их стоимости. Запускается для каждого офиса. Вычитывает события из очредеи, логирует в stdout.

## Архитектура RMQ

### rmq_main

- Принимает события от сервисов police_registration_publisher и insurance_event_registration_publisher
- Все сущности (включая обменники, очереди, привязки и shovel) описаны в конфигурации definitions.json
- Состоит из двух обменников
  - police_x (topic) - принимает события регистрации полисов от сервиса police_registration_publisher
  - ins_case_x (topic) - принимает события по страховым случаям и выплатам от insurance_event_registration_publisher
- Содержит следующие очереди
  - ins_cases_msk_q - в неё попадают все события по страховым случаям в МСК
  - ins_cases_spb_q - в неё попадают все события по страховым случаям в СПБ
  - logs_msk_q - все события в МСК (от обоих обменников)
  - logs_msk_q - все события в СПБ (от обоих обменников)
  - payment_log_q - все события по выплатам от обоих офисов
  - payments_msk_q - события по выплатам в МСК
  - payments_spb_q - события по выплатам в СПБ
  - police_reg_msk_q - события регистрации полисов в МСК
  - police_reg_spb_q - события регистрации полисов в СПБ
  - to_depers_q - абсолютно все события от обоих обменников. К этой очереди подключен shovel, передающий события в rmq_depers
- Содержит следующие привязки (exchange -> [routing_key] -> queue)
  - ins_case_x -> [ins_case.msk] -> ins_cases_msk_q - для событий по страховым случаям в МСК
  - ins_case_x -> [ins_case.spb] -> ins_cases_spb_q - для событий по страховым случаям в СПБ
  - ins_case_x -> [#.msk] -> logs_msk_q - для событий в МСК
  - ins_case_x -> [#.spb] -> logs_spb_q - для событий в СПБ
  - ins_case_x -> [payment.#] -> payment_log_q - для всех событий оплаты
  - ins_case_x -> [payment.msk] -> payments_msk_q - для всех событий оплаты в МСК
  - ins_case_x -> [payment.spb] -> payments_spb_q - для всех событий оплаты в СПБ
  - ins_case_x -> [#] -> to_depers_q - для всех событий и их передачи на деперсонализацию
  - police_x -> [#.msk] -> logs_msk_q - для событий в МСК
  - police_x -> [#.spb] -> logs_spb_q - для событий в СПБ
  - police_x -> [police.msk] -> police_reg_msk_q - для событий регистрации полисов в МСК
  - police_x -> [police.spb] -> police_reg_spb_q - для событий регистрации полисов в СПБ
  - police_x -> [#] -> to_depers_q - для всех событий и их передачи на деперсонализацию
- Настроен shovel для передачт сообщений из очереди to_depers_q в инстанс rmq_depers на обменник depers_x

### rmq_depers
- Принимает через shovel события на деперсонализацию
- Все сущности (обменники, очереди, привязки) описаны в definitions.json
- Включает в себя обменник
  - depers_x (fanout)
- Содержит очереди
  - pending_to_depers_q - очередь для вычитывания сервисом деперсонализации
- Содержит привязки (exchange -> [routing_key] -> queue)
  - depers_x -> [] -> pending_to_depers_q

## Запуск проекта и доступы
Для запуска требуются установленные docker и docker-compose.
Сервис на данный момент не хранит состояние, для стейтфул-поведения достаточно в docker-compose.yml добавить вольюмы к сервисам rmq_main и rmq_depers, замонтированные к /var/lib/rabbitmq.

Запуск проекта:

  docker-compose up --build

После запуска каждый из сервисов будет писать свой лог, по которому можно наблюдать за его поведением.

Для доступов к админкам RabbitMQ можно использовать стандартные креды (guest/guest) и следующие адреса:

rmq_main - http://127.0.0.1:15672

rmq_depers - http://127.0.0.1:15673
